# Отправка документа в Честный знак по API
## Получение токена
Клиент обратился с просьбой отправить документ по API, так как с сайта документ не загружался в систему из-за слишком большого размера. 

Естественно, первым шагом было обращение к документации Честного знака (спойлер 1: ничего непонятно, но очень интересно, еще и в открытом доступе актуальную версию не найти). 

Сначала по документации необходимо было получить токен для дальнейшего обмена документами. Состоял он из получения пары uuid, data (идентификатор текущей аутентификации и строка на подпись пользователю), отправки обратно этой пары, где data-уже подписанная Электронной подписью пользователя строка, ну и, конечно, танцев с бубнами. 

Первая проблема - понять по какому url отправлять, спасибо человеку, у которого было реальзовано получение токена на php, подглядела там. 

Вторая проблема - подписание и отправка этой строки, подписанной ЭЦП. В документации прописано, что подпись должна быть прикрепленная и в формате base64, но ни слова о том, что у подписи нужно убирать перенос строки, поэтому для успешного получения токена не забудьте это сделать. Про само подписывание, я это делала на онлайн платформе сбиса https://crypto.saby.ru/.

## Отправка документа
Мне необходимо было отправить документ "Ввод в оборот. Импорт с ФТС. 

!Документ был в формате json!

Здесь начинается самая интересная часть, в документации настолько расплывчато написано об этом, что пришлось напрямую обращаться тех.поддержке (спойлер 2: отвечают очень долго и по их рекомендациям ничего не работает), поэтому, пробовала все варианты отправки, которые возможно. 

Теперь к тому, как все-таки добиться результата. Вам необходимо будет указать номер товарной группы, тип документа и код типа документа, также открепленную ЭЦП в формате base64 и тело документа тоже в base64. Все параметры кроме подписи и документа, благо можно найти в документации, все остальное придется мучить своими силами. 

Первое - у меня была сформированная атк уже в json, но в тело документа к каждому коду товара, нужно было добавить всд и дату производства, также, как потом выяснилось нужно указывать номер атк (в документации опять же ни слова про это). Таким образом, документ у меня выглядел примерно так:

  

      {
        "trade_participant_inn":"7777777777",
        
        "declaration_number":"50999020/010721/0002040",
        
        "declaration_date":"2021-07-01",
        
        "production_date":"2021-06-17",
        
        "products_list":[
    
          {
      
          "cis":"00000000000000000000000000000000000004", #номер АТК
          
          "children":[ 
          
              #Далее сам документ
            {
              "ki":"0104622222222222215JFvd?",
              
              "production_date":"2020-06-10",
              
              "vsd_number":"222a2a22-aaa2-2a22-22aa-aa2222a22222"
              
            },
            
            {
              "ki":"0104633333333333215fEhY!",
              
              "production_date":"2021-06-17",
              
              "vsd_number":"333a3a33-aaa3-3a33-33aa-aa3333a33333"
              
            }
            
          ]
        
        }
        
      ]
      
    }


Документ сформирован, теперь его необходимо подписать, делала это на том же сайте, но можно делать и через командную строку:

1. Сформировать два файла telo.txt и sign_out.txt в C:\Users\name\Documents.
2. Открыть командную строку.
3. Выполнить в командной строке (cmd):
"c:\Program Files\Crypto Pro\CSP\csptest.exe" -sfsign -sign -detached -in C:\Users\name\Documents\telo.txt -out C:\Users\name\Documents\sign_out.txt -my (указать отпечаток сертификата) -base64 -add


## А теперь анекдот: "Просыпается отец семьи, идет в коровник..."
На самом деле, анекдот другой, очень долго не могли понять, почему проверка подписи не проходит, пишет, что подпись не соответсвует документу. Но как же так?! Тех.поддержка же сказала: подписали, перевели подпись и документ в base64, убрали перенос строки из документа с подписью и отправили. ВСЕ! 

Но как бы не так. Документ прошел все проверки после того, как подпись была отправлена без удаления переноса строк. Я мучалась кучу времени, пока однажды случайно не отправила в таком виде...
